<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My HTML Panel (Cloud Synced)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg-light: #f6f6f6;
      --bg-dark: #181a20;
      --panel-light: #fff;
      --panel-dark: #23262f;
      --text-light: #222;
      --text-dark: #f6f6f6;
      --accent: #007acc;
      --danger: #e74c3c;
      --border-radius: 8px;
      --box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      --item-hover: #333d4b;
      --selected-panel: #364156;
      --icon-label-dark: #f6f6f6;
      --icon-label-light: #222;
    }
    body {
      font-family: Arial,sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      transition: background 0.2s, color 0.2s;
    }
    .light-mode { background: var(--bg-light); color: var(--text-light); }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      background: var(--panel-dark);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 2rem;
      transition: background 0.2s;
      display: flex;
      gap: 2rem;
      align-items: flex-start;
    }
    .light-mode .container { background: var(--panel-light); }
    .sidebar {
      width: 220px;
      min-width: 180px;
      border-right: 2px solid #222;
      padding-right: 1.2rem;
      margin-right: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .light-mode .sidebar { border-right: 2px solid #ddd; }
    .panel-list {
      list-style: none; padding: 0; margin: 0;
      flex: 1;
    }
    .panel-list li {
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.2rem;
      border-radius: var(--border-radius);
      background: none;
      cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
      transition: background 0.2s;
      border: 2px solid transparent;
      position: relative;
    }
    .panel-list li.selected {
      background: var(--selected-panel);
      color: #fff;
      border-color: var(--accent);
    }
    .light-mode .panel-list li.selected { background: #eaf3fb; color: #222;}
    .panel-list li:hover {
      background: var(--item-hover);
      color: #fff;
    }
    .light-mode .panel-list li:hover { background: #dde5ef; color: #222;}
    .panel-actions button {
      margin-left: 0.15rem; background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1.1rem;
      padding: 0.2rem 0.4rem;
    }
    .panel-actions .remove { color: var(--danger);}
    .panel-actions .drag { cursor: grab;}
    .add-panel-form { display: flex; gap: 0.4rem; margin-top: 0.8rem;}
    .add-panel-form input { flex: 1; padding: 0.3rem; border-radius: var(--border-radius); border: 1px solid #888;
      background: #1a1d23; color: #fff; }
    .light-mode .add-panel-form input { background: #fff; color: #222;}
    .add-panel-form button { background: var(--accent); color: #fff; border: none; border-radius: var(--border-radius); padding: 0.3rem 0.9rem; cursor: pointer; }
    .main { flex: 3; }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 1.1rem;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .theme-toggle {
      background: var(--accent); color: #fff; border: none;
      padding: 0.4rem 0.7rem; border-radius: var(--border-radius);
      cursor: pointer;
    }
    .token-bar {
      font-size: 0.97rem;
      margin-bottom: 1.1rem;
      text-align: right;
      color: var(--accent);
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.7em;
      flex-wrap: wrap;
    }
    .token-bar input[type="password"] {
      font-size: 1em;
      padding: 0.2em 0.5em;
      border-radius: var(--border-radius);
      border: 1px solid #bbb;
      margin-right: 0.3em;
    }
    .token-bar button {
      background: var(--accent); color: #fff; border: none; border-radius: var(--border-radius); padding: 0.22em 0.8em; cursor: pointer; font-size: 0.97em;
    }
    .token-bar span {
      font-weight: bold;
      margin-right: 0.2em;
    }
    .title-block {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;
    }
    .main-title {
      font-size: 1.7rem; font-weight: bold; margin: 0;
      cursor: pointer;
      border-bottom: 1px dashed #888;
      padding-bottom: 2px;
      transition: background 0.2s;
      background: none;
    }
    .main-title:active, .main-title:focus { outline: none; background: var(--item-hover);}
    .edit-title-form input { font-size: 1.2rem; padding: 0.2rem 0.5rem; border-radius: var(--border-radius); border: 1px solid #888;}
    .edit-title-form button { margin-left: 0.3rem; background: var(--accent); color: #fff; border: none; border-radius: var(--border-radius); padding: 0.2rem 0.7rem; cursor: pointer;}
    .edit-title-form { display: flex; gap: 0.4rem;}
    form#addLinkForm { display: flex; gap: 0.5rem; margin-bottom: 1.5rem;}
    input[type="text"], input[type="url"] {
      flex: 1;
      padding: 0.5rem; border-radius: var(--border-radius); border: 1px solid #ccc;
      background: #1a1d23; color: #fff;
      transition: background 0.2s, color 0.2s;
    }
    .light-mode input[type="text"], .light-mode input[type="url"] {
      background: #fff; color: #222;
    }
    button[type="submit"] {
      background: var(--accent); color: #fff; border: none;
      border-radius: var(--border-radius); padding: 0.5rem 1.2rem; cursor: pointer;
    }
    ul.link-list { list-style: none; padding: 0; }
    ul.link-list li { margin: 1rem 0; display: flex; align-items: center; justify-content: space-between; background: none; border-radius: var(--border-radius);}
    ul.link-list li.dragging { opacity: 0.4; }
    .link-title { flex: 2; font-weight: bold; font-size: 1.1rem; }
    .link-url { flex: 3; margin-left: 1rem; word-break: break-all; color: var(--accent); text-decoration: none;}
    .link-actions { flex: 1; text-align: right;}
    .link-actions button { margin-left: 0.3rem; background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1.1rem; padding: 0.2rem 0.4rem;}
    .link-actions .remove { color: var(--danger);}
    .link-actions .drag { cursor: grab;}
    .edit-link-form { display: flex; gap: 0.5rem; margin-top: 0.5rem;}
    .edit-link-form input[type="text"], .edit-link-form input[type="url"] { padding: 0.3rem; border-radius: var(--border-radius); border: 1px solid #ccc;}
    /* --- Calculator Styles --- */
    .calculator-sidebar {
      width: 270px;
      min-width: 180px;
      margin-left: 1.2rem;
      display: flex;
      align-items: flex-start;
    }
    .calculator {
      width: 100%;
      background: var(--panel-dark);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1rem 1rem 1.2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 0.5rem;
    }
    .calculator input {
      font-size: 1.6rem;
      padding: 0.5rem;
      margin-bottom: 0.7rem;
      border-radius: var(--border-radius);
      border: 1px solid #888;
      background: #1a1d23;
      color: #fff;
      text-align: right;
    }
    .calculator .calc-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    .calculator button {
      font-size: 1.1rem;
      padding: 0.7rem 0;
      border-radius: var(--border-radius);
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
      outline: none;
    }
    .calculator button:active {
      background: var(--selected-panel);
    }
    .calculator button.calc-equals {
      background: #28a745;
    }
    .calculator button.calc-clear {
      background: var(--danger);
    }
    .light-mode .calculator {
      background: var(--panel-light);
    }
    .light-mode .calculator input {
      background: #fff;
      color: #222;
    }
    .light-mode .calculator button {
      background: var(--accent);
      color: #fff;
    }
    .light-mode .calculator button.calc-equals {
      background: #3dcc67;
    }
    .light-mode .calculator button.calc-clear {
      background: #e74c3c;
    }
    @media (max-width: 1050px) {
      .container { flex-direction: column; gap: 0.5rem;}
      .sidebar { width: auto; min-width: 0; border-right: none; padding-right: 0; margin-right: 0;}
      .main { width: 100%;}
      .calculator-sidebar { width: 100%; margin-left: 0; margin-top: 1.5rem;}
      .calculator { max-width: 320px; margin: 0 auto; }
      .top-bar { justify-content: flex-start;}
      .token-bar { text-align: left; font-size: 1em;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <ul class="panel-list" id="panelList"></ul>
    <form class="add-panel-form" id="addPanelForm">
      <input type="text" id="newPanelTitle" placeholder="New panel name" required>
      <button type="submit" title="Add Panel">+</button>
    </form>
  </div>
  <div class="main">
    <div class="token-bar" id="tokenBar"></div>
    <div class="top-bar">
      <button class="theme-toggle" id="themeToggle">Light Mode</button>
    </div>
    <div class="title-block" id="panelTitleBlock">
      <h1 class="main-title" id="mainTitle" tabindex="0" title="Click to edit"></h1>
    </div>
    <form id="addLinkForm">
      <input type="text" id="linkTitle" placeholder="Link title" required>
      <input type="url" id="linkUrl" placeholder="https://example.com/page.html" required>
      <button type="submit">Add Link</button>
    </form>
    <ul class="link-list" id="linksList"></ul>
  </div>
  <!-- Calculator Sidebar -->
  <div class="calculator-sidebar">
    <div class="calculator" id="calculator">
      <input type="text" id="calcDisplay" readonly>
      <div class="calc-buttons"></div>
    </div>
  </div>
</div>
<script>
const OWNER = 'lhwongn-bot';
const REPO = 'My-Panel';
const BRANCH = 'main';
const FILE = 'panel-data.json';

let ghToken = '';
let panels = [];
let currentPanel = 0;
let fileSha = null;
let saveTimer = null;

const panelList = document.getElementById("panelList");
const addPanelForm = document.getElementById("addPanelForm");
const newPanelTitle = document.getElementById("newPanelTitle");
const mainTitle = document.getElementById("mainTitle");
const panelTitleBlock = document.getElementById("panelTitleBlock");
const addLinkForm = document.getElementById("addLinkForm");
const linkTitle = document.getElementById("linkTitle");
const linkUrl = document.getElementById("linkUrl");
const linksList = document.getElementById("linksList");
const themeToggle = document.getElementById("themeToggle");
const tokenBar = document.getElementById("tokenBar");

// --- THEME LOGIC ---
function setTheme(mode) {
  if (mode === "light") {
    document.body.classList.add("light-mode");
    themeToggle.textContent = "Dark Mode";
  } else {
    document.body.classList.remove("light-mode");
    themeToggle.textContent = "Light Mode";
  }
  localStorage.setItem('panel_theme', mode);
}
themeToggle.onclick = () => {
  const curr = document.body.classList.contains("light-mode") ? "light" : "dark";
  setTheme(curr === "light" ? "dark" : "light");
  // Update calculator colors if necessary (handled by CSS)
};
(function() {
  let mode = localStorage.getItem('panel_theme') || "dark";
  setTheme(mode);
})();

// --- TOKEN UI ---
function escapeHtml(str){return (str+'').replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));}
function renderTokenBar(statusMsg = "") {
  // statusMsg can be "Saving...", "Saved", etc.
  let html = `<input type="password" id="ghTokenInput" placeholder="GitHub token" size="20" value="${ghToken?escapeHtml(ghToken):""}">
    <button id="ghTokenSetBtn">Set</button>
    <button id="ghTokenCheckBtn">Check</button>
    <span id="ghTokenStatus" style="color:#888;">${statusMsg}</span>`;
  tokenBar.innerHTML = html;
  document.getElementById("ghTokenSetBtn").onclick = function() {
    const val = document.getElementById("ghTokenInput").value.trim();
    if(val) setToken(val);
    else alert('Please enter a valid GitHub token');
  };
  document.getElementById("ghTokenCheckBtn").onclick = async function() {
    const val = document.getElementById("ghTokenInput").value.trim();
    let span = document.getElementById("ghTokenStatus");
    if (!val) { span.innerText = "Please enter a token first."; return; }
    span.innerText = "Checking token...";
    try {
      const resp = await fetch('https://api.github.com/user', {
        headers: {'Authorization': 'token ' + val, 'Accept': 'application/vnd.github+json'}
      });
      if (resp.ok) {
        const user = await resp.json();
        span.innerText = "Valid: " + user.login;
      } else {
        span.innerText = "Invalid token or permissions";
      }
    } catch (e) {
      span.innerText = "Network error";
    }
  };
}

// --- GITHUB SYNC LOGIC ---
function getHeaders(isPut){
  return {
    'Authorization': 'token '+ghToken,
    'Accept': 'application/vnd.github+json',
    ...(isPut ? {'Content-Type':'application/json'} : {})
  };
}
// Unicode safe base64 for JSON (Chinese/UTF-8 support)
function base64EncodeUnicode(str) {
  return btoa(unescape(encodeURIComponent(str)));
}
function base64DecodeUnicode(str) {
  return decodeURIComponent(escape(atob(str)));
}

async function fetchPanels(){
  if (!ghToken) { renderTokenBar('Token required'); return; }
  renderTokenBar('Loading...');
  try{
    const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}?ref=${BRANCH}`,{
      headers: getHeaders()
    });
    if(r.status===404){
      panels=[{title:'My Panel',links:[]}]; fileSha=null;
      renderTokenBar('New file'); savePanels(true);
      return;
    }
    const j = await r.json();
    fileSha = j.sha;
    panels = JSON.parse(base64DecodeUnicode(j.content));
    for(const p of panels){ if(!Array.isArray(p.links)) p.links=[]; }
    if(!Array.isArray(panels)) panels=[{title:'My Panel',links:[]}];
    renderTokenBar('Loaded');
  }catch(e){
    renderTokenBar('Failed to load panels');
    panels=[{title:'My Panel',links:[]}];
  }
  renderPanelList(); renderPanel();
}
// Save with SHA retry on conflict
async function savePanels(isInit, retry=false){
  renderTokenBar('Saving...');
  try{
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}`,{
      method:'PUT',
      headers: getHeaders(true),
      body: JSON.stringify({
        message: isInit?'Create panel-data.json':'Update panel-data.json',
        content: base64EncodeUnicode(JSON.stringify(panels,null,2)),
        branch: BRANCH,
        sha: fileSha||undefined
      })
    });
    const resp = await res.json();
    if(resp && resp.content && resp.content.sha){
      fileSha=resp.content.sha;
      renderTokenBar('Saved');
    }else if(resp && resp.message && resp.message.includes('sha does not match') && !retry){
      // Try to refresh sha and retry
      const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}?ref=${BRANCH}`,{headers: getHeaders()});
      const j = await r.json();
      fileSha = j.sha;
      return await savePanels(isInit, true);
    }else{
      throw new Error(resp.message||'Unknown error');
    }
  }catch(e){
    renderTokenBar('Save failed');
    alert('Failed to save: '+e);
  }
}
function queueSave(){
  renderTokenBar('Saving...');
  if(saveTimer)clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>savePanels(false), 900);
}
function saveIfDirty(){
  if(saveTimer) { clearTimeout(saveTimer); savePanels(false);}
}

// --- TOKEN LOGIC ---
function setToken(token) {
  ghToken = token;
  localStorage.setItem('gh_token_panel', token);
  fetchPanels();
}
(function loadSavedToken(){
  let stored = localStorage.getItem('gh_token_panel');
  if(stored){
    ghToken = stored;
    fetchPanels();
  } else {
    renderTokenBar('');
  }
})();

// --- PANEL UI LOGIC ---
function renderPanelList() {
  panelList.innerHTML = "";
  panels.forEach((panel, idx) => {
    const li = document.createElement("li");
    li.draggable = true;
    li.className = idx === currentPanel ? "selected" : "";
    li.textContent = panel.title;
    li.onclick = () => { currentPanel = idx; renderPanelList(); renderPanel(); };
    const actions = document.createElement("span");
    actions.className = "panel-actions";
    const editBtn = document.createElement("button");
    editBtn.innerHTML = "âœï¸";
    editBtn.title = "Rename";
    editBtn.onclick = (e) => {
      e.stopPropagation(); startEditPanelTitle(idx);
    };
    const removeBtn = document.createElement("button");
    removeBtn.innerHTML = "ðŸ—‘ï¸";
    removeBtn.className = "remove";
    removeBtn.title = "Delete";
    removeBtn.onclick = async (e) => {
      e.stopPropagation();
      if (panels.length === 1) { alert("Cannot remove last panel."); return; }
      if (confirm("Delete this panel and all its links?")) {
        panels.splice(idx,1);
        if (currentPanel >= panels.length) currentPanel = panels.length-1;
        queueSave();
        renderPanelList();
        renderPanel();
      }
    };
    const dragBtn = document.createElement("button");
    dragBtn.innerHTML = "â†•ï¸";
    dragBtn.className = "drag";
    dragBtn.title = "Drag to reorder";
    dragBtn.setAttribute("draggable", "true");
    dragBtn.onmousedown = (e) => { e.stopPropagation(); };
    actions.append(editBtn, removeBtn, dragBtn);
    li.appendChild(actions);
    // Drag & drop
    li.addEventListener('dragstart', (e) => {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', idx.toString());
      li.classList.add('dragging');
    });
    li.addEventListener('dragend', (e) => {
      li.classList.remove('dragging');
    });
    li.addEventListener('dragover', (e) => {
      e.preventDefault(); li.style.borderColor = "var(--accent)";
    });
    li.addEventListener('dragleave', (e) => {
      li.style.borderColor = "transparent";
    });
    li.addEventListener('drop', async (e) => {
      e.preventDefault();
      li.style.borderColor = "transparent";
      const fromIdx = parseInt(e.dataTransfer.getData('text/plain'),10);
      const toIdx = idx;
      if (fromIdx !== toIdx) {
        const moved = panels.splice(fromIdx,1)[0];
        panels.splice(toIdx,0,moved);
        if (currentPanel === fromIdx) currentPanel = toIdx;
        else if (currentPanel > fromIdx && currentPanel <= toIdx) currentPanel--;
        else if (currentPanel < fromIdx && currentPanel >= toIdx) currentPanel++;
        queueSave();
        renderPanelList();
        renderPanel();
      }
    });
    panelList.appendChild(li);
  });
}
function startEditPanelTitle(idx) {
  const li = panelList.children[idx];
  if (!li) return;
  li.innerHTML = "";
  const form = document.createElement("form");
  form.className = "edit-title-form";
  const input = document.createElement("input");
  input.type = "text";
  input.value = panels[idx].title;
  input.required = true;
  form.appendChild(input);
  const saveBtn = document.createElement("button");
  saveBtn.type = "submit";
  saveBtn.textContent = "Save";
  form.appendChild(saveBtn);
  const cancelBtn = document.createElement("button");
  cancelBtn.type = "button";
  cancelBtn.textContent = "Cancel";
  form.appendChild(cancelBtn);
  form.onsubmit = async (e) => {
    e.preventDefault();
    panels[idx].title = input.value;
    queueSave();
    renderPanelList();
    renderPanel();
  };
  cancelBtn.onclick = (e) => {
    renderPanelList();
  };
  li.appendChild(form);
  input.focus();
}
addPanelForm.onsubmit = async (e) => {
  e.preventDefault();
  const title = newPanelTitle.value.trim();
  if (!title) return;
  panels.push({ title, links: [] });
  currentPanel = panels.length-1;
  queueSave();
  newPanelTitle.value = "";
  renderPanelList();
  renderPanel();
};
function renderPanel() {
  panelTitleBlock.innerHTML = "";
  if (!panels[currentPanel]) return;
  function showTitle() {
    panelTitleBlock.innerHTML = "";
    const h1 = document.createElement("h1");
    h1.className = "main-title";
    h1.id = "mainTitle";
    h1.textContent = panels[currentPanel].title;
    h1.tabIndex = 0;
    h1.title = "Click to edit title";
    h1.onclick = () => showEditTitle();
    h1.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") showEditTitle();
    };
    panelTitleBlock.appendChild(h1);
  }
  async function showEditTitle() {
    panelTitleBlock.innerHTML = "";
    const form = document.createElement("form");
    form.className = "edit-title-form";
    const input = document.createElement("input");
    input.type = "text";
    input.value = panels[currentPanel].title;
    input.required = true;
    form.appendChild(input);
    const saveBtn = document.createElement("button");
    saveBtn.type = "submit";
    saveBtn.textContent = "Save";
    form.appendChild(saveBtn);
    const cancelBtn = document.createElement("button");
    cancelBtn.type = "button";
    cancelBtn.textContent = "Cancel";
    form.appendChild(cancelBtn);
    form.onsubmit = async (e) => {
      e.preventDefault();
      panels[currentPanel].title = input.value;
      queueSave();
      showTitle();
      renderPanelList();
    };
    cancelBtn.onclick = () => showTitle();
    panelTitleBlock.appendChild(form);
    input.focus();
  }
  showTitle();
  addLinkForm.style.display = "flex";
  linkTitle.value = "";
  linkUrl.value = "";
  renderLinks();
}
function renderLinks() {
  linksList.innerHTML = "";
  const links = panels[currentPanel].links;
  links.forEach((link, idx) => {
    const li = document.createElement("li");
    li.draggable = true;
    if (link.editing) {
      const editForm = document.createElement("form");
      editForm.className = "edit-link-form";
      const editTitle = document.createElement("input");
      editTitle.type = "text";
      editTitle.value = link.title;
      editTitle.required = true;
      const editUrl = document.createElement("input");
      editUrl.type = "url";
      editUrl.value = link.url;
      editUrl.required = true;
      const saveBtn = document.createElement("button");
      saveBtn.type = "submit";
      saveBtn.textContent = "Save";
      const cancelBtn = document.createElement("button");
      cancelBtn.type = "button";
      cancelBtn.textContent = "Cancel";
      cancelBtn.onclick = () => { delete links[idx].editing; renderLinks(); };
      editForm.onsubmit = async (e) => {
        e.preventDefault();
        links[idx].title = editTitle.value;
        links[idx].url = editUrl.value;
        delete links[idx].editing;
        queueSave();
        renderLinks();
      };
      editForm.append(editTitle, editUrl, saveBtn, cancelBtn);
      li.appendChild(editForm);
    } else {
      const titleSpan = document.createElement("span");
      titleSpan.className = "link-title";
      titleSpan.textContent = link.title;
      const urlA = document.createElement("a");
      urlA.className = "link-url";
      urlA.href = link.url;
      urlA.target = "_blank";
      urlA.rel = "noopener";
      urlA.textContent = link.url;
      const actions = document.createElement("span");
      actions.className = "link-actions";
      const editBtn = document.createElement("button");
      editBtn.title = "Edit";
      editBtn.innerHTML = "âœï¸";
      editBtn.onclick = () => { links[idx].editing = true; renderLinks(); };
      const removeBtn = document.createElement("button");
      removeBtn.title = "Remove";
      removeBtn.className = "remove";
      removeBtn.innerHTML = "ðŸ—‘ï¸";
      removeBtn.onclick = async () => {
        if (confirm("Remove this link?")) {
          links.splice(idx, 1);
          queueSave();
          renderLinks();
        }
      };
      const dragBtn = document.createElement("button");
      dragBtn.innerHTML = "â†•ï¸";
      dragBtn.className = "drag";
      dragBtn.title = "Drag to reorder";
      dragBtn.setAttribute("draggable", "true");
      dragBtn.onmousedown = (e) => { e.stopPropagation(); };
      actions.append(editBtn, removeBtn, dragBtn);
      li.append(titleSpan, urlA, actions);
    }
    li.addEventListener('dragstart', (e) => {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/link-idx', idx.toString());
      li.classList.add('dragging');
    });
    li.addEventListener('dragend', (e) => {
      li.classList.remove('dragging');
    });
    li.addEventListener('dragover', (e) => {
      e.preventDefault(); li.style.borderColor = "var(--accent)";
    });
    li.addEventListener('dragleave', (e) => {
      li.style.borderColor = "transparent";
    });
    li.addEventListener('drop', async (e) => {
      e.preventDefault();
      li.style.borderColor = "transparent";
      const fromIdx = parseInt(e.dataTransfer.getData('text/link-idx'),10);
      const toIdx = idx;
      if (fromIdx !== toIdx) {
        const moved = links.splice(fromIdx,1)[0];
        links.splice(toIdx,0,moved);
        queueSave();
        renderLinks();
      }
    });
    linksList.appendChild(li);
  });
}
addLinkForm.onsubmit = async (e) => {
  e.preventDefault();
  const title = linkTitle.value.trim();
  const url = linkUrl.value.trim();
  if (!title || !url) return;
  panels[currentPanel].links.push({ title, url });
  queueSave();
  linkTitle.value = "";
  linkUrl.value = "";
  renderLinks();
};

// --- Simple Calculator Logic ---
(function() {
  const calcDisplay = document.getElementById('calcDisplay');
  const calcButtons = [
    '7','8','9','/',
    '4','5','6','*',
    '1','2','3','-',
    '0','.','=','+',
    'C'
  ];
  let current = '';
  let shouldReset = false;
  function renderCalcButtons() {
    const grid = document.getElementById('calculator').querySelector('.calc-buttons');
    grid.innerHTML = '';
    calcButtons.forEach(label => {
      const btn = document.createElement('button');
      btn.textContent = label;
      if (label === '=') btn.classList.add('calc-equals');
      if (label === 'C') btn.classList.add('calc-clear');
      btn.onclick = () => calcPress(label);
      grid.appendChild(btn);
    });
  }
  function calcPress(label) {
    if (label === 'C') {
      current = '';
      calcDisplay.value = '';
      shouldReset = false;
    } else if (label === '=') {
      try {
        // Only allow safe eval (numbers and operators)
        if (/^[\d+\-*/.() ]+$/.test(current)) {
          let result = eval(current);
          if (typeof result === 'number' && isFinite(result)) {
            current = String(result);
            calcDisplay.value = current;
          } else {
            calcDisplay.value = 'Error';
            current = '';
          }
        } else {
          calcDisplay.value = 'Error';
          current = '';
        }
      } catch {
        calcDisplay.value = 'Error';
        current = '';
      }
      shouldReset = true;
    } else {
      if (shouldReset) {
        current = '';
        calcDisplay.value = '';
        shouldReset = false;
      }
      current += label;
      calcDisplay.value = current;
    }
  }
  if (document.getElementById('calculator')) {
    renderCalcButtons();
  }
  // Theme updates handled by CSS
})();
</script>
</body>
</html>